---
- name: Install Java, Logstash, and Nginx (with Dependencies)
  hosts: logstash_server
  become: yes

  tasks:
    - name: Install Java for Logstash
      yum:
        name: java-11-openjdk
        state: present

    - name: Register Java in alternatives
      command: alternatives --install /usr/bin/java java /usr/lib/jvm/java-11-openjdk/bin/java 1
      args:
        creates: /etc/alternatives/java

    - name: Set Java as default
      command: alternatives --set java /usr/lib/jvm/java-11-openjdk/bin/java
      ignore_errors: yes  # 등록되지 않은 경우를 대비해 에러 무시

    - name: Verify Java Installation
      command: java -version
      register: java_version_output
      changed_when: false  # 🔥 여기가 원래 틀렸던 부분 수정!

    - name: Display Java Version
      debug:
        msg: "{{ java_version_output.stdout_lines }}"

    - name: Import Elastic GPG Key
      rpm_key:
        key: https://artifacts.elastic.co/GPG-KEY-elasticsearch
        state: present

    - name: Add Logstash Repository
      yum_repository:
        name: elastic-7.x
        description: Elastic repository for 7.x packages
        baseurl: https://artifacts.elastic.co/packages/7.x/yum
        gpgcheck: yes
        gpgkey: https://artifacts.elastic.co/GPG-KEY-elasticsearch
        enabled: yes

    - name: Install Logstash
      yum:
        name: logstash
        state: present

    - name: Enable and Start Logstash Service
      systemd:
        name: logstash
        enabled: yes
        state: started
